<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Diabetes Medicine & Insurance Cost Tool</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Bootstrap -->
    <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    />

    <style>
        body {
            background: #f5f7fb;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }

        .app-shell {
            max-width: 1100px;
        }

        .hero-title {
            font-weight: 700;
            letter-spacing: 0.02em;
        }

        .hero-badge {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .hero-subtitle {
            max-width: 700px;
            margin: 0 auto;
            color: #6c757d;
        }

        .card-elevated {
            border: none;
            border-radius: 1rem;
            box-shadow:
                0 18px 40px rgba(15, 23, 42, 0.08),
                0 0 0 1px rgba(148, 163, 184, 0.15);
        }

        .card-section-title {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: #6c757d;
        }

        .summary-number {
            font-size: 1.6rem;
            font-weight: 700;
        }

        .summary-label {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: #6c757d;
        }

        .table thead th {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #6c757d;
            border-bottom-width: 1px;
        }

        .table td {
            vertical-align: middle;
            font-size: 0.9rem;
        }

        .coverage-chip {
            display: inline-flex;
            align-items: center;
            padding: 0.15rem 0.55rem;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .coverage-yes {
            background: #d1f5e0;
            color: #157347;
        }

        .coverage-no {
            background: #fde2e1;
            color: #b02a37;
        }

        .coverage-partial {
            background: #fff3cd;
            color: #856404;
        }

        .row-good-coverage {
            background-color: #ecfdf3;
        }

        .row-no-coverage {
            background-color: #fef2f2;
        }

        .compare-hint {
            font-size: 0.85rem;
            color: #6c757d;
        }

        .legend-dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 999px;
            margin-right: 4px;
        }

        .legend-green {
            background: #16a34a;
        }

        .legend-yellow {
            background: #facc15;
        }

        .legend-red {
            background: #dc2626;
        }
    </style>
</head>
<body>
<div class="container app-shell py-5">

    <!-- HEADER -->
    <header class="text-center mb-5">
        <div class="hero-badge text-uppercase text-primary fw-semibold mb-2">
            Diabetes Cost Comparison
        </div>
        <h1 class="hero-title mb-3">Diabetes Medicine &amp; Insurance Tool</h1>
        <p class="hero-subtitle">
            Compare the yearly and monthly costs of diabetes medications across different insurance
            plans. Choose your medicine and insurance to see coverage details, copays, and
            estimated out-of-pocket costs.
        </p>
    </header>

    <!-- STEP 1: CHOOSE COMBINATION -->
    <section class="mb-4">
        <div class="card card-elevated">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <div class="card-section-title">1 · Choose a combination</div>
                        <h5 class="mb-0">Select your medicine and insurance plan</h5>
                    </div>
                </div>

                <p class="compare-hint mb-4">
                    Select both to see one detailed result, or leave one blank to compare all options.
                    When you choose a medicine or an insurance plan, the other dropdown will show
                    <strong>(Yes)</strong> or <strong>(No)</strong> to indicate coverage in our data.
                </p>

                <form method="POST">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-5">
                            <label for="medicine" class="form-label fw-semibold">
                                Medicine
                            </label>
                            <select id="medicine" name="medicine" class="form-select">
                                <option value="">All medicines</option>
                                {% for med in medicines %}
                                    <option value="{{ med }}"
                                        {% if selected_medicine == med %}selected{% endif %}>
                                        {{ med }}
                                    </option>
                                {% endfor %}
                            </select>
                            <div class="small text-muted mt-1" id="medicineHelp"></div>
                        </div>

                        <div class="col-md-5">
                            <label for="insurance" class="form-label fw-semibold">
                                Insurance
                            </label>
                            <select id="insurance" name="insurance" class="form-select">
                                <option value="">All insurance plans</option>
                                {% for ins in insurances %}
                                    <option value="{{ ins }}"
                                        {% if selected_insurance == ins %}selected{% endif %}>
                                        {{ ins }}
                                    </option>
                                {% endfor %}
                            </select>
                            <div class="small text-muted mt-1" id="insuranceHelp"></div>
                        </div>

                        <div class="col-md-2 d-grid">
                            <button type="submit" class="btn btn-primary btn-lg">
                                Compare
                            </button>
                        </div>
                    </div>
                </form>

            </div>
        </div>
    </section>

    <!-- STEP 2: SELECTED COMBINATION -->
    {% if current %}
    <section class="mb-4">
        <div class="card card-elevated">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <div class="card-section-title">2 · Your selected combination</div>
                        <h5 class="mb-1">
                            {{ current.medicine.medicine_name }} with {{ current.insurance.insurance_name }}
                        </h5>
                        {% if current.coverage %}
                            {% if current.coverage.covered == 'Yes' %}
                                <span class="coverage-chip coverage-yes mt-1">
                                    Covered · Tier {{ current.coverage.tier_level }}
                                </span>
                            {% elif current.coverage.covered %}
                                <span class="coverage-chip coverage-partial mt-1">
                                    {{ current.coverage.covered }} · Tier {{ current.coverage.tier_level }}
                                </span>
                            {% else %}
                                <span class="coverage-chip coverage-partial mt-1">
                                    Coverage details limited
                                </span>
                            {% endif %}
                        {% else %}
                            <span class="coverage-chip coverage-no mt-1">
                                No coverage info in our data
                            </span>
                        {% endif %}
                    </div>
                    <div class="text-end">
                        <div class="summary-label mb-1">Estimated annual</div>
                        <div class="summary-number mb-0">
                            ${{ current.annual_cost|money }}
                        </div>
                        <div class="text-muted small">
                            ≈ ${{ current.monthly_cost|money }} / month
                        </div>
                    </div>
                </div>

                <div class="row g-4">
                    <div class="col-md-6">
                        <h6 class="text-uppercase text-muted mb-2">Medicine details</h6>
                        <div class="border rounded-3 p-3 bg-light">
                            <p class="mb-1"><strong>Name:</strong> {{ current.medicine.medicine_name }}</p>
                            <p class="mb-1"><strong>Type:</strong> {{ current.medicine.type }}</p>
                            <p class="mb-1"><strong>Effectiveness:</strong> {{ current.medicine.effectiveness_rating }}/10</p>
                            <p class="mb-0"><strong>Base monthly:</strong> ${{ current.medicine.average_cost_per_month|money }}</p>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <h6 class="text-uppercase text-muted mb-2">Insurance details</h6>
                        <div class="border rounded-3 p-3 bg-light">
                            <p class="mb-1"><strong>Plan:</strong> {{ current.insurance.insurance_name }}</p>
                            <p class="mb-1"><strong>Provider:</strong> {{ current.insurance.provider }}</p>
                            <p class="mb-1"><strong>Copay (primary care):</strong> ${{ current.insurance.copay_primary_care|money }}</p>
                            <p class="mb-0"><strong>Deductible:</strong> ${{ current.insurance.deductible|money }}</p>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </section>
    {% endif %}

    <!-- STEP 3: EXPLORE OPTIONS (TABLE) -->
    {% if pairings %}
    <section class="mb-5">
        <div class="card card-elevated">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div>
                        <div class="card-section-title mb-2">3 · Explore options</div>
                        <h5 class="mb-1">Matching combinations</h5>
                        <p class="compare-hint mb-1">
                            Showing {{ pairings|length }} option(s).
                            You can sort by <strong>monthly or annual cost</strong>
                            and switch between <strong>cheapest → highest</strong> or
                            <strong>highest → cheapest</strong>.
                        </p>
                        <!-- SORT CONTROLS -->
                        <div class="mt-2 d-flex flex-wrap align-items-center gap-2">
                            <div class="small text-muted me-1">Sort by:</div>
                            <select id="sortMetric" class="form-select form-select-sm w-auto">
                                <option value="annual" selected>Annual cost</option>
                                <option value="monthly">Monthly cost</option>
                            </select>
                            <div class="small text-muted ms-3 me-1">Order:</div>
                            <select id="sortOrder" class="form-select form-select-sm w-auto">
                                <option value="asc" selected>Cheapest → Highest</option>
                                <option value="desc">Highest → Cheapest</option>
                            </select>
                        </div>
                    </div>
                    <div class="text-end small text-muted d-none d-md-block">
                        <div>
                            <span class="legend-dot legend-green"></span> Covered
                        </div>
                        <div>
                            <span class="legend-dot legend-yellow"></span> Limited / special coverage
                        </div>
                        <div>
                            <span class="legend-dot legend-red"></span> No coverage
                        </div>
                    </div>
                </div>

                <div class="table-responsive mt-3">
                    <table class="table table-sm table-striped align-middle">
                        <thead>
                            <tr>
                                <th>Medicine</th>
                                <th>Insurance</th>
                                <th>Coverage</th>
                                <th>Monthly cost</th>
                                <th>Annual cost</th>
                                <th class="text-end">Details</th>
                            </tr>
                        </thead>
                        <tbody id="pairingsBody">
                            {% for p in pairings %}
                                <tr
                                    class="{% if p.coverage and p.coverage.covered == 'Yes' %}row-good-coverage{% elif not p.coverage %}row-no-coverage{% endif %}"
                                    data-annual="{{ p.annual_cost }}"
                                    data-monthly="{{ p.monthly_cost }}"
                                >
                                    <td>{{ p.medicine_name }}</td>
                                    <td>{{ p.insurance_name }}</td>
                                    <td>
                                        {% if p.coverage and p.coverage.covered == 'Yes' %}
                                            <span class="coverage-chip coverage-yes">Covered</span>
                                        {% elif p.coverage %}
                                            <span class="coverage-chip coverage-partial">
                                                {{ p.coverage.covered }}
                                            </span>
                                        {% else %}
                                            <span class="coverage-chip coverage-no">No coverage</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if p.copay_amount is not none %}
                                            ${{ p.copay_amount|money }}
                                            {% if p.monthly_savings is not none and p.monthly_savings > 0 %}
                                                <br />
                                                <small class="text-muted">
                                                    was ${{ p.full_monthly|money }},
                                                    save ${{ p.monthly_savings|money }} / mo
                                                </small>
                                            {% endif %}
                                        {% else %}
                                            ${{ p.full_monthly|money }}
                                        {% endif %}
                                    </td>
                                    <td>
                                        <strong>${{ p.annual_cost|money }}</strong>
                                        {% if p.annual_savings is not none and p.annual_savings > 0 %}
                                            <br />
                                            <small class="text-muted">
                                                was ${{ p.full_annual|money }},
                                                save ${{ p.annual_savings|money }} / yr
                                            </small>
                                        {% endif %}
                                    </td>
                                    <td class="text-end">
                                        <form method="POST" class="d-inline">
                                            <input type="hidden" name="medicine" value="{{ p.medicine_name }}">
                                            <input type="hidden" name="insurance" value="{{ p.insurance_name }}">
                                            <button class="btn btn-sm btn-outline-primary">
                                                View
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Legend for mobile -->
                <div class="mt-3 d-md-none small text-muted">
                    <div>
                        <span class="legend-dot legend-green"></span> Covered
                    </div>
                    <div>
                        <span class="legend-dot legend-yellow"></span> Limited / special coverage
                    </div>
                    <div>
                        <span class="legend-dot legend-red"></span> No coverage
                    </div>
                </div>

            </div>
        </div>
    </section>
    {% endif %}

    <footer class="pt-4 text-center text-muted small">
        Educational comparison only — always confirm costs with your doctor, insurer, and pharmacist.
    </footer>
</div>

<!-- coverage map for JS dropdown labels -->
<script id="coverage-data" type="application/json">
    {{ coverage_map|safe }}
</script>

<script>
    // coverageMap[medicine][insurance] = { covered, copay_amount, tier_level }
    var coverageMap = {};
    (function () {
        try {
            var el = document.getElementById("coverage-data");
            if (!el) return;
            var txt = el.textContent || el.innerText || "";
            coverageMap = txt ? JSON.parse(txt) : {};
        } catch (e) {
            console.warn("Failed to parse coverage map JSON", e);
            coverageMap = {};
        }
    })();

    var medicineBaseLabels = {};
    var insuranceBaseLabels = {};

    function resetMedicineLabels() {
        var medSelect = document.getElementById("medicine");
        if (!medSelect) return;
        for (var i = 0; i < medSelect.options.length; i++) {
            var opt = medSelect.options[i];
            if (!opt.value) continue;
            if (medicineBaseLabels[opt.value]) {
                opt.text = medicineBaseLabels[opt.value];
            }
        }
    }

    function resetInsuranceLabels() {
        var insSelect = document.getElementById("insurance");
        if (!insSelect) return;
        for (var i = 0; i < insSelect.options.length; i++) {
            var opt = insSelect.options[i];
            if (!opt.value) continue;
            if (insuranceBaseLabels[opt.value]) {
                opt.text = insuranceBaseLabels[opt.value];
            }
        }
    }

    // Annotate insurances when a medicine is selected
    function annotateInsuranceOptions(selectedMed) {
        var insSelect = document.getElementById("insurance");
        var help = document.getElementById("insuranceHelp");
        if (!insSelect) return;

        resetInsuranceLabels();
        if (help) help.textContent = "";

        if (!selectedMed) return;

        for (var i = 0; i < insSelect.options.length; i++) {
            var opt = insSelect.options[i];
            if (!opt.value) continue;

            var base = insuranceBaseLabels[opt.value] || opt.value;
            var hasCoverage = false;

            if (coverageMap[selectedMed] && coverageMap[selectedMed][opt.value]) {
                var cov = coverageMap[selectedMed][opt.value];
                if (cov && cov.covered === "Yes") {
                    hasCoverage = true;
                }
            }

            opt.text = base + (hasCoverage ? " (Yes)" : " (No)");
        }

        if (help) {
            help.textContent = "Each insurance now shows (Yes) or (No) based on coverage for " + selectedMed + " in our data.";
        }
    }

    // Annotate medicines when an insurance is selected
    function annotateMedicineOptions(selectedIns) {
        var medSelect = document.getElementById("medicine");
        var help = document.getElementById("medicineHelp");
        if (!medSelect) return;

        resetMedicineLabels();
        if (help) help.textContent = "";

        if (!selectedIns) return;

        for (var i = 0; i < medSelect.options.length; i++) {
            var opt = medSelect.options[i];
            if (!opt.value) continue;

            var base = medicineBaseLabels[opt.value] || opt.value;
            var hasCoverage = false;

            if (coverageMap[opt.value] && coverageMap[opt.value][selectedIns]) {
                var cov = coverageMap[opt.value][selectedIns];
                if (cov && cov.covered === "Yes") {
                    hasCoverage = true;
                }
            }

            opt.text = base + (hasCoverage ? " (Yes)" : " (No)");
        }

        if (help) {
            help.textContent = "Each medicine now shows (Yes) or (No) based on coverage under " + selectedIns + " in our data.";
        }
    }

    // --- client-side sorting for Explore options table ---
    function sortPairingsTable() {
        var tbody = document.getElementById("pairingsBody");
        if (!tbody) return;

        var metricSelect = document.getElementById("sortMetric");
        var orderSelect = document.getElementById("sortOrder");

        var metric = metricSelect ? metricSelect.value : "annual";
        var order = orderSelect ? orderSelect.value : "asc";

        var key = metric === "monthly" ? "monthly" : "annual";

        var rows = Array.prototype.slice.call(tbody.querySelectorAll("tr"));

        rows.sort(function (a, b) {
            var av = parseFloat(a.dataset[key] || "0");
            var bv = parseFloat(b.dataset[key] || "0");

            if (isNaN(av)) av = 0;
            if (isNaN(bv)) bv = 0;

            if (av < bv) return order === "asc" ? -1 : 1;
            if (av > bv) return order === "asc" ? 1 : -1;
            return 0;
        });

        rows.forEach(function (row) {
            tbody.appendChild(row);
        });
    }

    document.addEventListener("DOMContentLoaded", function () {
        var medSelect = document.getElementById("medicine");
        var insSelect = document.getElementById("insurance");
        var metricSelect = document.getElementById("sortMetric");
        var orderSelect = document.getElementById("sortOrder");

        // Save base labels for all options
        if (medSelect) {
            for (var i = 0; i < medSelect.options.length; i++) {
                var opt = medSelect.options[i];
                if (!opt.value) continue;
                medicineBaseLabels[opt.value] = opt.text;
            }
        }

        if (insSelect) {
            for (var j = 0; j < insSelect.options.length; j++) {
                var opt2 = insSelect.options[j];
                if (!opt2.value) continue;
                insuranceBaseLabels[opt2.value] = opt2.text;
            }
        }

        // When user changes medicine: annotate insurances
        if (medSelect) {
            medSelect.addEventListener("change", function () {
                annotateInsuranceOptions(this.value);
            });
        }

        // When user changes insurance: annotate medicines
        if (insSelect) {
            insSelect.addEventListener("change", function () {
                annotateMedicineOptions(this.value);
            });
        }

        // If page loaded with selections from a POST, re-annotate
        if (medSelect && medSelect.value) {
            annotateInsuranceOptions(medSelect.value);
        }
        if (insSelect && insSelect.value) {
            annotateMedicineOptions(insSelect.value);
        }

        // Sorting controls
        if (metricSelect) {
            metricSelect.addEventListener("change", sortPairingsTable);
        }
        if (orderSelect) {
            orderSelect.addEventListener("change", sortPairingsTable);
        }

        // initial sort (cheapest annual at top)
        sortPairingsTable();
    });
</script>

</body>
</html>
